#!/bin/bash
#
# Wrapper for xcrun that forces a custom device set for simctl commands

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REAL_XCRUN=$(PATH="${PATH//$SCRIPT_DIR:/}" command -v xcrun)

# If --set is specified respect that and pass through unchanged
for arg in "$@"; do
	if [[ "$arg" == "--set" ]]; then
		exec "$REAL_XCRUN" "$@"
	fi
done

# If the subcommand is 'simctl', inject --set $__RADON_CUSTOM_DEVICE_SET after 'simctl'
if [[ "$1" == "simctl" ]]; then
	echo "[xcrun-shim] $(date +%s) - simctl called with args: ${@:2}" >>"$HOME/maestro-shim.log"
	# When launching the app, we may need to pass the metro port as well
	if [[ $2 == "launch" && "$*" == *"$__RADON_APP_ID"* ]]; then
		exec "$REAL_XCRUN" "$1" --set "$__RADON_CUSTOM_DEVICE_SET" "${@:2}" -RCT_jsLocation "localhost:${__RADON_METRO_PORT}"
	else
		exec "$REAL_XCRUN" "$1" --set "$__RADON_CUSTOM_DEVICE_SET" "${@:2}"
	fi
else
	exec "$REAL_XCRUN" "$@"
fi
